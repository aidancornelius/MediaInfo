name: Sync Upstream

on:
  schedule:
    # Check for upstream changes daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/sbarex/MediaInfo.git || true
          git fetch upstream --tags

      - name: Sync with upstream
        run: |
          git checkout master
          git merge upstream/master --no-edit || {
            echo "Merge conflict detected. Manual intervention required."
            exit 1
          }
          git push origin master --tags

      - name: Check for new release tags
        id: check_release
        run: |
          # Get latest upstream tag
          LATEST_TAG=$(git describe --tags --abbrev=0 upstream/master 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ]; then
            # Check if we already have a release for this tag
            if ! gh release view "${LATEST_TAG}-signed" &>/dev/null; then
              echo "new_release=true" >> $GITHUB_OUTPUT
              echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger build workflow
        if: steps.check_release.outputs.new_release == 'true'
        run: |
          gh workflow run build-release.yml -f tag=${{ steps.check_release.outputs.tag }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
